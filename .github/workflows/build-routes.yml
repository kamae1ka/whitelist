name: Build Network Routes

on:
  push:
    branches:
      - '*'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Generate all-routes.txt
        run: |
          > all-routes.txt
          resources=$(yq eval '.app | keys | .[]' resources.yaml)
          for res in $resources; do
            echo "Processing $res..."
            
            # Check if resource has new structure (with 'as' and 'networks' keys)
            has_as=$(yq eval ".app.$res.as" resources.yaml 2>/dev/null || echo "null")
            has_networks=$(yq eval ".app.$res.networks" resources.yaml 2>/dev/null || echo "null")
            
            if [ "$has_as" != "null" ] || [ "$has_networks" != "null" ]; then
              # New structure: app.name.as[] and app.name.networks[]
              
              # Process AS numbers
              if [ "$has_as" != "null" ]; then
                ass=$(yq eval ".app.$res.as[]" resources.yaml 2>/dev/null || echo "")
                for as_str in $ass; do
                  if [ -n "$as_str" ]; then
                    # Extract AS number from format AS11281 -> 11281
                    asn=$(echo "$as_str" | sed 's/^AS//')
                    echo "  Fetching AS $asn for $res"
                    cidrs=$(curl -s "https://stat.ripe.net/data/announced-prefixes/data.json?resource=AS$asn" | jq -r '.data.prefixes[]?.prefix // empty' | grep -v '^$' | grep -v ':' || true)
                    if [ -n "$cidrs" ]; then
                      for cidr in $cidrs; do
                        echo "$cidr" >> all-routes.txt
                      done
                    else
                      echo "  No IPv4 prefixes found for AS $asn"
                    fi
                  fi
                done
              fi
              
              # Process custom networks
              if [ "$has_networks" != "null" ]; then
                networks=$(yq eval ".app.$res.networks[]" resources.yaml 2>/dev/null || echo "")
                for network in $networks; do
                  if [ -n "$network" ]; then
                    echo "  Adding custom network: $network"
                    echo "$network" >> all-routes.txt
                  fi
                done
              fi
            else
              # Old structure: app.name[] (just list of AS)
              ass=$(yq eval ".app.$res[]" resources.yaml 2>/dev/null || echo "")
              for as_str in $ass; do
                if [ -n "$as_str" ]; then
                  # Extract AS number from format AS11281 -> 11281
                  asn=$(echo "$as_str" | sed 's/^AS//')
                  echo "  Fetching AS $asn for $res"
                  cidrs=$(curl -s "https://stat.ripe.net/data/announced-prefixes/data.json?resource=AS$asn" | jq -r '.data.prefixes[]?.prefix // empty' | grep -v '^$' | grep -v ':' || true)
                  if [ -n "$cidrs" ]; then
                    for cidr in $cidrs; do
                      echo "$cidr" >> all-routes.txt
                    done
                  else
                    echo "  No IPv4 prefixes found for AS $asn"
                  fi
                fi
              done
            fi
          done
          
          # Sort and deduplicate routes
          sort -u all-routes.txt > all-routes-sorted.txt
          mv all-routes-sorted.txt all-routes.txt
          
          echo "Generated all-routes.txt with $(wc -l < all-routes.txt) routes before aggregation"
          
      - name: Aggregate routes (remove subnets covered by larger prefixes)
        run: |
          python3 << 'EOF'
          import ipaddress
          import sys
          
          # Read all prefixes
          prefixes = []
          with open('all-routes.txt', 'r') as f:
              for line in f:
                  line = line.strip()
                  if line:
                      try:
                          prefixes.append(ipaddress.IPv4Network(line, strict=False))
                      except ValueError:
                          continue
          
          # Sort by prefix length (larger networks first, then smaller)
          # This ensures we check larger networks first
          prefixes.sort(key=lambda x: (x.prefixlen, int(x.network_address)))
          
          # Filter out subnets that are covered by larger prefixes
          filtered = []
          for prefix in prefixes:
              is_covered = False
              for larger in filtered:
                  # Check if this prefix is a subnet of any already added prefix
                  if larger.supernet_of(prefix):
                      is_covered = True
                      break
              if not is_covered:
                  filtered.append(prefix)
          
          # Write filtered prefixes back, sorted by network address
          filtered.sort(key=lambda x: int(x.network_address))
          with open('all-routes.txt', 'w') as f:
              for prefix in filtered:
                  f.write(str(prefix) + '\n')
          
          print(f"Aggregation complete: {len(prefixes)} -> {len(filtered)} routes")
          print(f"Removed {len(prefixes) - len(filtered)} redundant subnets")
          EOF
          
          echo "After aggregation: $(wc -l < all-routes.txt) routes"

      - name: Generate MikroTik .rsc file
        run: |
          LIST_NAME="whitelist-routes"
          OUTPUT_FILE="mikrotik-whitelist.rsc"
          
          echo "# MikroTik RouterOS Script" > "$OUTPUT_FILE"
          echo "# Generated whitelist routes for Address List" >> "$OUTPUT_FILE"
          echo "# Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"
          echo "# Remove existing address list entries" >> "$OUTPUT_FILE"
          echo "/ip firewall address-list remove [find list=\"$LIST_NAME\"]" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"
          echo "# Add routes to address list" >> "$OUTPUT_FILE"
          
          # Process all-routes.txt and generate commands
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              route=$(echo "$line" | xargs)
              if [[ "$route" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/[0-9]+$ ]]; then
                echo "/ip firewall address-list add list=\"$LIST_NAME\" address=\"$route\" comment=\"whitelist-auto\"" >> "$OUTPUT_FILE"
              fi
            fi
          done < all-routes.txt
          
          echo "" >> "$OUTPUT_FILE"
          echo "# Script completed" >> "$OUTPUT_FILE"
          
          echo "Generated $OUTPUT_FILE with $(wc -l < all-routes.txt) routes"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if file exists and has content
          if [ ! -f all-routes.txt ] || [ ! -s all-routes.txt ]; then
            echo "Error: all-routes.txt is empty or missing"
            exit 1
          fi
          
          # Save generated file before switching branches
          cp all-routes.txt all-routes-generated.txt
          
          # Ensure we're on main branch
          git fetch origin main:main 2>/dev/null || true
          git checkout main 2>/dev/null || git checkout -b main
          
          # Restore generated files
          mv all-routes-generated.txt all-routes.txt
          cp mikrotik-whitelist.rsc mikrotik-whitelist-generated.rsc
          git checkout main -- mikrotik-whitelist.rsc 2>/dev/null || true
          mv mikrotik-whitelist-generated.rsc mikrotik-whitelist.rsc
          
          # Add and commit (git will detect if there are changes)
          git add all-routes.txt mikrotik-whitelist.rsc
          if git diff --cached --quiet; then
            echo "No changes to all-routes.txt"
          else
            git commit -m "Update all routes $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:main
            echo "Successfully pushed changes to main"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

